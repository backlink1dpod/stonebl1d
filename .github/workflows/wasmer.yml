name: Deploy to Wasmer

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Hugo
        run: |
          wget -O ${{ runner.temp }}/hugo.deb https://github.com/gohugoio/hugo/releases/download/v0.151.0/hugo_extended_0.151.0_linux-amd64.deb \
          && sudo dpkg -i ${{ runner.temp }}/hugo.deb

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies & Build
        # QUAN TRá»ŒNG: Wasmer sáº½ cáº¥p domain dáº¡ng https://<package>.wasmer.app/
        # Báº¡n cáº§n thay tháº¿ link dÆ°á»›i báº±ng link thá»±c táº¿ Wasmer cáº¥p sau láº§n deploy Ä‘áº§u
        run: |
          npm install
          hugo --minify --baseURL "https://stonebl1d.wasmer.app/"

      - name: Install Wasmer CLI
        uses: wasmerio/setup-wasmer@v3.1

# ğŸ‘‡ THÃŠM BÆ¯á»šC NÃ€Y VÃ€O ÄÃ‚Y ğŸ‘‡
      - name: Auto-bump Version
        run: |
          # Lá»‡nh nÃ y sáº½ thay tháº¿ dÃ²ng version="xxx" thÃ nh version="0.0.<sá»‘-láº§n-cháº¡y>"
          sed -i "s/^version = \".*\"/version = \"0.0.${{ github.run_number }}\"/" wasmer.toml
          
          # In ra Ä‘á»ƒ kiá»ƒm tra
          grep "version =" wasmer.toml

      - name: Deploy to Wasmer
        env:
          WASMER_TOKEN: ${{ secrets.WASMER_TOKEN }}
        run: wasmer deploy --non-interactive